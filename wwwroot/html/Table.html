<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Table</title>
    <!-- Materialize CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <style>
        /* Переопределение стандартной подсветки на голубой цвет */
        .input-field input:focus {
            border-bottom: 2px solid #2196F3 !important; /* Голубой цвет */
            box-shadow: 0 1px 0 0 #2196F3 !important; /* Голубой цвет */
        }

            .input-field input:focus + label {
                color: #2196F3 !important; /* Голубой цвет */
            }
    </style>
    <!-- Materialize JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>

        let tables = [];

        async function Home() {
            StopConnection();
            window.location.href = '/Home';
        }
        async function StartConnection() {
            const connectionPort = document.getElementById('connectionPort').value;
            await fetch(`/api/Table/start?connectionPort=${connectionPort}`);
        }
        async function StopConnection() {
            await fetch('/api/Table/stop');
        }

        async function addTable() {
            const tableId = document.getElementById('newTableId').value;
            const addresses = document.getElementById('addresses').value;

            if (!tableId || !addresses) {
                alert('Пожалуйста, заполните все поля.');
                return;
            }

            const addressesArray = addresses.split(',').map(Number);

            const response = await fetch(`/api/Table/AddNewTable`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: tableId, addresses: addressesArray })
            });

            if (response.ok) {
                const tableContainer = document.createElement('div');
                tableContainer.innerHTML =
                    `
                        <h4>${tableId}</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>Название параметра</th>
                                    <th>Значение</th>
                                    <th>Ед.изм</th>
                                    <th>Адрес</th>
                                    <th>Формат</th>
                                    <th>Вид</th>
                                    <th>Размер</th>
                                </tr>
                            </thead>
                            <tbody id="${tableId}">
                            </tbody>
                        </table>
                    `;
                document.getElementById('tablesContainer').appendChild(tableContainer);
                tables.push({ id: tableId, addresses: addressesArray });
            } else {
                alert('Ошибка при добавлении таблицы.');
            }
        }

        async function updateData() {
            const response = await fetch(`/api/Table/GetConnectionStatus`);
            const connectionStatus = await response.text();
            document.getElementById(`conectionStatus`).innerHTML = connectionStatus;

            // *** Работа с таблицей ***
            const modbusID = document.getElementById('modbusID').value;
            if (modbusID != "") {
                for (const table of tables) {
                    const tableId = table.id;
                    const tableDataResponse = await fetch(`/api/Table/GetTableData?modbusID=${modbusID}&tableId=${tableId}`);
                    const tableData = await tableDataResponse.json();

                    const tableBody = document.getElementById(tableId);
                    tableBody.innerHTML = ''; // Очистка текущей таблицы

                    tableData.forEach((row, index) => {
                        const tr = document.createElement('tr');

                        // Добавление столбца с названиями параметров
                        const tdName = document.createElement('td');
                        tdName.textContent = `Parameter ${index + 1}`; // Пример названия параметра
                        tr.appendChild(tdName);

                        const tdValue = document.createElement('td');
                        tdValue.textContent = row;
                        tr.appendChild(tdValue);

                        const tdUnitType = document.createElement('td');
                        tdUnitType.textContent = "-";
                        tr.appendChild(tdUnitType);

                        const tdAddress = document.createElement('td');
                        tdAddress.textContent = table.addresses[index];
                        tr.appendChild(tdAddress);

                        const tdValueFormat = document.createElement('td');
                        tdValueFormat.textContent = "int16";
                        tr.appendChild(tdValueFormat);

                        const tdValueType = document.createElement('td');
                        tdValueType.textContent = "dec";
                        tr.appendChild(tdValueType);

                        const tdValueSize = document.createElement('td');
                        tdValueSize.textContent = "1";
                        tr.appendChild(tdValueSize);

                        tableBody.appendChild(tr);
                    });
                }
            }
        }

        setInterval(updateData, 1); // Обновление каждые 100 миллисекунд
        updateData(); // Первоначальное обновление
    </script>
</head>
<body>
    <header>
        <nav class="waves-effect waves-light blue">
            <div class="nav-wrapper">
                <ul id="nav" style="margin-inline:15px;" class="left hide-on-med-and-down">
                    <li><a href="#" onclick="Home()">Home</a></li>
                    <li><a href="#" onclick="StartConnection()">Start</a></li>
                    <li><a href="#" onclick="StopConnection()">Stop</a></li>
                    <li><a href="#" style="font-weight: 600; padding-left: 20px; padding-right: 20px;" class="brand-logo">Device-Table</a></li>
                </ul>
            </div>
        </nav>
    </header>
    <div class="container">
        <div>
            <h4 id="conectionStatus"></h4>
            <div class="input-field col s6">
                <input id="connectionPort" type="number" class="validate">
                <label for="connectionPort">Enter connection port</label>
            </div>
            <div class="input-field col s6">
                <input id="modbusID" type="number" class="validate">
                <label for="modbusID">ModbusID</label>
            </div>
            <div class="row">
                <div class="input-field col s4">
                    <input id="newTableId" type="text" class="validate">
                    <label for="newTableId">ID</label>
                </div>
                <div class="input-field col s4">
                    <input id="addresses" type="text" class="validate">
                    <label for="addresses">Массив адресов (через запятую)</label>
                </div>
                <div class="col s4">
                    <button class="btn waves-effect waves-light" onclick="addTable()">Добавить таблицу</button>
                </div>
            </div>
        </div>
        <div id="tablesContainer"></div>
    </div>
</body>
</html>
