<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Table</title>
    <!-- Materialize CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <style>

        .tables-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        /* Переопределение стандартной подсветки на голубой цвет */
        .input-field input:focus {
            border-bottom: 2px solid #2196F3 !important; /* Голубой цвет */
            box-shadow: 0 1px 0 0 #2196F3 !important; /* Голубой цвет */
        }

            .input-field input:focus + label {
                color: #2196F3 !important; /* Голубой цвет */
            }

        .table-section {
            margin: 15px;
            padding: 20px;
            border: 1px solid #2196F3;
            width: fit-content;
        }

        .table-section-body {
            display: flex;
            flex-direction: row;
        }

        .table-section-header {
            color: #2782C3;
            font-family: Roboto;
            font-size: 24px;
            font-style: normal;
            font-weight: 400;
            line-height: normal;
        }

        .table-section-body {
            display: flex;
            flex-direction: row;
            justify-content: flex-start;
            align-items: baseline;
            gap: 25px;
        }

        .table-section-table {
            /* Стили для таблицы */
        }
    </style>
    <!-- Materialize JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <!-- xlsx Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var elems = document.querySelectorAll('.collapsible');
            var instances = M.Collapsible.init(elems);
        });

        let tables = [];
        let updateToken = true;

        async function Home() {
            StopConnection();
            window.location.href = '/Home';
        }
        async function StartConnection() {
            const connectionPort = document.getElementById('connectionPort').value;
            await fetch(`/api/Table/start?connectionPort=${connectionPort}`);
        }
        async function StopConnection() {
            await fetch('/api/Table/stop');
        }

        async function addTable() {
            const tableId = document.getElementById('newTableId').value;
            const names = document.getElementById('newTableNames').value;
            const addresses = document.getElementById('addresses').value;
            const sizes = document.getElementById('newTableSizes').value;
            const types = document.getElementById('newTableTypes').value;
            const unitTypes = document.getElementById('newTableUnitTypes').value;
            const formats = document.getElementById('newTableFormats').value;

            if (!tableId || !addresses) {
                alert('Пожалуйста, заполните все поля.');
                return;
            }

            const namesArray = names.split(',').map(String);
            const addressesArray = addresses.split(',').map(Number);
            const sizesArray = sizes.split(',').map(Number);
            const typesArray = types.split(',').map(String);
            const unitTypesArray = unitTypes.split(',').map(String);
            const formatsArray = formats.split(',').map(String);

            const response = await fetch(`/api/Table/AddNewTable`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: tableId, names: namesArray, addresses: addressesArray, sizes: sizesArray, types: typesArray, unitTypes: unitTypesArray, formats: formatsArray })
            });

            if (response.ok) {
                const tableContainer = document.createElement('div');
                tableContainer.innerHTML =
                    `
                        <section class="table-section">
                            <h4 class="table-section-header">${tableId}</h4>
                                <div class="table-section-body">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Название параметра</th>
                                            <th>Значение</th>
                                            <th>Ед.изм</th>
                                            <th>Адрес</th>
                                            <th>Формат</th>
                                            <th>Вид</th>
                                            <th>Размер</th>
                                        </tr>
                                    </thead>
                                    <tbody id="${tableId}">
                                    </tbody>
                                </table>
                                </div>
                            </section>
                            `;
                document.getElementById('tablesContainer').appendChild(tableContainer);
                tables.push({ id: tableId, names: namesArray, addresses: addressesArray, sizes: sizesArray, types: typesArray, unitTypes: unitTypesArray, formats: formatsArray });
            } else {
                alert('Ошибка при добавлении таблицы.');
            }
        }

        async function updateData() {
            const response = await fetch(`/api/Table/GetConnectionStatus`);
            const connectionStatus = await response.text();
            document.getElementById(`conectionStatus`).innerHTML = connectionStatus;

            if (updateToken === true) {
                updateToken = false;

                // *** Работа с таблицей ***
                const modbusID = document.getElementById('modbusID').value;
                if (modbusID != "") {
                    for (const table of tables) {
                        const tableId = table.id;
                        const tableDataResponse = await fetch(`/api/Table/GetTableData?modbusID=${modbusID}&tableId=${tableId}`);
                        const tableData = await tableDataResponse.json();

                        const tableBody = document.getElementById(tableId);
                        tableBody.innerHTML = ''; // Очистка текущей таблицы

                        tableData.forEach((row, index) => {
                            const tr = document.createElement('tr');

                            // Добавление столбца с названиями параметров
                            const tdName = document.createElement('td');
                            tdName.textContent = table.names[index];
                            tr.appendChild(tdName);

                            const tdValue = document.createElement('td');
                            tdValue.textContent = row;
                            tr.appendChild(tdValue);

                            const tdUnitType = document.createElement('td');
                            tdUnitType.textContent = table.unitTypes[index];
                            tr.appendChild(tdUnitType);

                            const tdAddress = document.createElement('td');
                            tdAddress.textContent = table.addresses[index];
                            tr.appendChild(tdAddress);

                            const tdValueFormat = document.createElement('td');
                            tdValueFormat.textContent = table.formats[index];
                            tr.appendChild(tdValueFormat);

                            const tdValueType = document.createElement('td');
                            tdValueType.textContent = table.types[index];;
                            tr.appendChild(tdValueType);

                            const tdValueSize = document.createElement('td');
                            tdValueSize.textContent = table.sizes[index];
                            tr.appendChild(tdValueSize);

                            tableBody.appendChild(tr);
                        });
                    }
                }

                updateToken = true;
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            const fileName = file.name.replace(/\.[^/.]+$/, ""); // Удаляем расширение файла
            const reader = new FileReader();

            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                let currentTableId = null;
                let currentTable = null;
                let currentGroupName = null;

                jsonData.forEach(row => {
                    const idParts = row[0].split('.');
                    const tableIdPart = idParts[0];
                    const groupName = row[1];
                    const parameter = idParts[2];

                    const tableId = `${fileName}    ${groupName}`;

                    if (tableIdPart !== currentTableId) {
                        if (currentTable) {
                            addTableFromData(`${fileName}   ${currentGroupName}`, currentTable.names, currentTable.addresses, currentTable.sizes, currentTable.types, currentTable.unitTypes, currentTable.formats);
                        }
                        currentTableId = tableIdPart;
                        currentGroupName = groupName;
                        currentTable = {
                            names: [],
                            addresses: [],
                            sizes: [],
                            types: [],
                            unitTypes: [],
                            formats: []
                        };
                    }

                    currentTable.names.push(row[1]);
                    currentTable.unitTypes.push(row[3]);
                    currentTable.types.push(row[5]);
                    currentTable.formats.push(row[4]);
                    currentTable.addresses.push(row[6]);
                    currentTable.sizes.push(row[12]);

                });

                if (currentTable) {
                    addTableFromData(`${fileName}   ${currentGroupName}`, currentTable.names, currentTable.addresses, currentTable.sizes, currentTable.types, currentTable.unitTypes, currentTable.formats);
                }
            };

            reader.readAsArrayBuffer(file);
        }

        async function addTableFromData(tableId, names, addresses, sizes, types, unitTypes, formats) {
            try {
                // Преобразование строк в числа
                addresses = addresses.map(addr => addr === "" ? 0 : parseInt(addr, 10));
                sizes = sizes.map(size => size === "" ? 0 : parseInt(size, 10));

                const jsonData = JSON.stringify({
                    id: tableId,
                    names: names,
                    addresses: addresses,
                    sizes: sizes,
                    types: types,
                    unitTypes: unitTypes,
                    formats: formats
                });
                console.log('JSON данные для отправки:', jsonData);
                const response = await fetch(`/api/Table/AddNewTable`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: tableId,
                        names: names,
                        addresses: addresses,
                        sizes: sizes,
                        types: types,
                        unitTypes: unitTypes,
                        formats: formats
                    })
                });

                if (response.ok) {
                    const tableContainer = document.createElement('div');
                    tableContainer.innerHTML =
                        `
                <section class="table-section">
                    <h4 class="table-section-header">${tableId}</h4>
                    <div class="table-section-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>Название параметра</th>
                                    <th>Значение</th>
                                    <th>Ед.изм</th>
                                    <th>Адрес</th>
                                    <th>Формат</th>
                                    <th>Вид</th>
                                    <th>Размер</th>
                                </tr>
                            </thead>
                            <tbody id="${tableId}">
                            </tbody>
                        </table>
                    </div>
                </section>
                `;
                    document.getElementById('tablesContainer').appendChild(tableContainer);
                    tables.push({ id: tableId, names: names, addresses: addresses, sizes: sizes, types: types, unitTypes: unitTypes, formats: formats });
                } else {
                    alert('Ошибка при добавлении таблицы.');
                }
            } catch (error) {
                console.error('Ошибка при отправке данных на сервер:', error);
                alert('Произошла ошибка при отправке данных на сервер. Пожалуйста, проверьте формат данных.');
            }
        }


        setInterval(updateData, 100); // Обновление каждые 100 миллисекунд
        updateData(); // Первоначальное обновление
    </script>
</head>
<body>
    <header>
        <nav class="waves-effect waves-light blue">
            <div class="nav-wrapper">
                <ul id="nav" style="margin-inline:15px;" class="left hide-on-med-and-down">
                    <li><a href="#" onclick="Home()">Home</a></li>
                    <li><a href="#" onclick="StartConnection()">Start</a></li>
                    <li><a href="#" onclick="StopConnection()">Stop</a></li>
                    <li><a href="#" style="font-weight: 600; padding-left: 20px; padding-right: 20px;" class="brand-logo">Device-Table</a></li>
                </ul>
            </div>
        </nav>
    </header>
    <div class="container">
        <div class="row">
            <h4 id="conectionStatus"></h4>
            <ul class="collapsible">
                <li>
                    <div class="collapsible-header">Настройки соединения</div>
                    <div class="collapsible-body">
                        <div class="row">
                            <div class="input-field col s6">
                                <input id="connectionPort" type="number" class="validate">
                                <label for="connectionPort">Enter connection port</label>
                            </div>
                            <div class="input-field col s6">
                                <input id="modbusID" type="number" class="validate">
                                <label for="modbusID">ModbusID</label>
                            </div>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
        <ul class="collapsible">
            <li>
                <div class="collapsible-header">Добавление таблицы</div>
                <div class="collapsible-body">
                    <div class="row">
                        <div class="input-field col s4">
                            <input id="newTableId" type="text" class="validate">
                            <label for="newTableId">ID</label>
                        </div>
                        <div class="input-field col s4">
                            <input id="newTableNames" type="text" class="validate">
                            <label for="newTableNames">Массив названий (через запятую)</label>
                        </div>
                        <div class="input-field col s4">
                            <input id="addresses" type="text" class="validate">
                            <label for="addresses">Массив адресов (через запятую)</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s4">
                            <input id="newTableSizes" type="text" class="validate">
                            <label for="newTableSizes">Массив размеров (через запятую)</label>
                        </div>
                        <div class="input-field col s4">
                            <input id="newTableTypes" type="text" class="validate">
                            <label for="newTableTypes">Массив видов (через запятую)</label>
                        </div>
                        <div class="input-field col s4">
                            <input id="newTableUnitTypes" type="text" class="validate">
                            <label for="newTableUnitTypes">Массив единиц изм. (через запятую)</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s4">
                            <input id="newTableFormats" type="text" class="validate">
                            <label for="newTableFormats">Массив форматов (через запятую)</label>
                        </div>
                        <div class="col s4">
                            <button class="btn waves-effect waves-light blue" onclick="addTable()">Добавить таблицу по заданным параметрам</button>
                        </div>
                        <div class="col s4">
                            <input type="file" id="fileInput" onchange="handleFileUpload(event)" accept=".xlsx, .xls">
                        </div>
                    </div>
                </div>
            </li>
        </ul>
    </div>
    <div id="tablesContainer" class="tables-container"></div>
    </div>
</body>
</html>
